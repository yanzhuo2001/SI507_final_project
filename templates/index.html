<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Finder</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/style.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Restaurant Finder</h1>

        <!-- 搜索框 -->
        <form action="/" method="POST" class="mb-3" id="search-form">
            <div class="form-group">
                <input type="text" class="form-control" name="search_query" placeholder="Search for restaurants">
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <!-- 筛选框 -->
        <form action="/filter" method="POST" id="filter-form">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="categories">Categories:</label>
                        <select multiple class="form-control" name="categories" id="categories">
                            <option value="">Any</option>
                            <option value="African">African</option>
                            <option value="American (New)">American (New)</option>
                            <option value="American (Traditional)">American (Traditional)</option>
                            <option value="Art Galleries">Art Galleries</option>
                            <option value="Asian Fusion">Asian Fusion</option>
                            <option value="Bagels">Bagels</option>
                            <option value="Bakeries">Bakeries</option>
                            <option value="Barbeque">Barbeque</option>
                            <option value="Bars">Bars</option>
                            <option value="Beer Bar">Beer Bar</option>
                            <option value="Beer Gardens">Beer Gardens</option>
                            <option value="Beer, Wine & Spirits">Beer, Wine & Spirits</option>
                            <option value="Beverage Store">Beverage Store</option>
                            <option value="Boating">Boating</option>
                            <option value="Bowling">Bowling</option>
                            <option value="Brazilian">Brazilian</option>
                            <option value="Breakfast & Brunch">Breakfast & Brunch</option>
                            <option value="Breweries">Breweries</option>
                            <option value="Brewpubs">Brewpubs</option>
                            <option value="Bubble Tea">Bubble Tea</option>
                            <option value="Buffets">Buffets</option>
                            <option value="Burgers">Burgers</option>
                            <option value="Cafes">Cafes</option>
                            <option value="Cafeteria">Cafeteria</option>
                            <option value="Cajun/Creole">Cajun/Creole</option>
                            <option value="Car Wash">Car Wash</option>
                            <option value="Caribbean">Caribbean</option>
                            <option value="Caterers">Caterers</option>
                            <option value="Cheese Shops">Cheese Shops</option>
                            <option value="Cheesesteaks">Cheesesteaks</option>
                            <option value="Chicken Shop">Chicken Shop</option>
                            <option value="Chicken Wings">Chicken Wings</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Cocktail Bars">Cocktail Bars</option>
                            <option value="Coffee & Tea">Coffee & Tea</option>
                            <option value="Coffee Roasteries">Coffee Roasteries</option>
                            <option value="Comfort Food">Comfort Food</option>
                            <option value="Convenience Stores">Convenience Stores</option>
                            <option value="Cooking Schools">Cooking Schools</option>
                            <option value="Creperies">Creperies</option>
                            <option value="Cuban">Cuban</option>
                            <option value="Cupcakes">Cupcakes</option>
                            <option value="Dance Clubs">Dance Clubs</option>
                            <option value="Delis">Delis</option>
                            <option value="Desserts">Desserts</option>
                            <option value="Dim Sum">Dim Sum</option>
                            <option value="Diners">Diners</option>
                            <option value="Dive Bars">Dive Bars</option>
                            <option value="Donuts">Donuts</option>
                            <option value="Empanadas">Empanadas</option>
                            <option value="Ethiopian">Ethiopian</option>
                            <option value="Falafel">Falafel</option>
                            <option value="Fast Food">Fast Food</option>
                            <option value="Fish & Chips">Fish & Chips</option>
                            <option value="Food Court">Food Court</option>
                            <option value="Food Delivery Services">Food Delivery Services</option>
                            <option value="Food Stands">Food Stands</option>
                            <option value="Food Trucks">Food Trucks</option>
                            <option value="French">French</option>
                            <option value="Gastropubs">Gastropubs</option>
                            <option value="Gelato">Gelato</option>
                            <option value="German">German</option>
                            <option value="Gluten-Free">Gluten-Free</option>
                            <option value="Greek">Greek</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Halal">Halal</option>
                            <option value="Hawaiian">Hawaiian</option>
                            <option value="Himalayan/Nepalese">Himalayan/Nepalese</option>
                            <option value="Hookah Bars">Hookah Bars</option>
                            <option value="Hot Dogs">Hot Dogs</option>
                            <option value="Hot Pot">Hot Pot</option>
                            <option value="Hungarian">Hungarian</option>
                            <option value="Ice Cream & Frozen Yogurt">Ice Cream & Frozen Yogurt</option>
                            <option value="Indian">Indian</option>
                            <option value="International Grocery">International Grocery</option>
                            <option value="Irish">Irish</option>
                            <option value="Italian">Italian</option>
                            <option value="Japanese">Japanese</option>
                            <option value="Jazz & Blues">Jazz & Blues</option>
                            <option value="Juice Bars & Smoothies">Juice Bars & Smoothies</option>
                            <option value="Korean">Korean</option>
                            <option value="Kosher">Kosher</option>
                            <option value="Latin American">Latin American</option>
                            <option value="Lebanese">Lebanese</option>
                            <option value="Lounges">Lounges</option>
                            <option value="Meat Shops">Meat Shops</option>
                            <option value="Mediterranean">Mediterranean</option>
                            <option value="Mexican">Mexican</option>
                            <option value="Middle Eastern">Middle Eastern</option>
                            <option value="Moroccan">Moroccan</option>
                            <option value="Music Venues">Music Venues</option>
                            <option value="Musical Instruments & Teachers">Musical Instruments & Teachers</option>
                            <option value="New Mexican Cuisine">New Mexican Cuisine</option>
                            <option value="Noodles">Noodles</option>
                            <option value="Pancakes">Pancakes</option>
                            <option value="Pasta Shops">Pasta Shops</option>
                            <option value="Persian/Iranian">Persian/Iranian</option>
                            <option value="Pizza">Pizza</option>
                            <option value="Poke">Poke</option>
                            <option value="Polish">Polish</option>
                            <option value="Pool Halls">Pool Halls</option>
                            <option value="Pop-Up Restaurants">Pop-Up Restaurants</option>
                            <option value="Pubs">Pubs</option>
                            <option value="Ramen">Ramen</option>
                            <option value="Restaurants">Restaurants</option>
                            <option value="Russian">Russian</option>
                            <option value="Salad">Salad</option>
                            <option value="Sandwiches">Sandwiches</option>
                            <option value="Seafood">Seafood</option>
                            <option value="Seafood Markets">Seafood Markets</option>
                            <option value="Singaporean">Singaporean</option>
                            <option value="Soul Food">Soul Food</option>
                            <option value="Soup">Soup</option>
                            <option value="Southern">Southern</option>
                            <option value="Spanish">Spanish</option>
                            <option value="Specialty Food">Specialty Food</option>
                            <option value="Sports Bars">Sports Bars</option>
                            <option value="Steakhouses">Steakhouses</option>
                            <option value="Street Vendors">Street Vendors</option>
                            <option value="Supper Clubs">Supper Clubs</option>
                            <option value="Sushi Bars">Sushi Bars</option>
                            <option value="Szechuan">Szechuan</option>
                            <option value="Tacos">Tacos</option>
                            <option value="Taiwanese">Taiwanese</option>
                            <option value="Tapas Bars">Tapas Bars</option>
                            <option value="Tapas/Small Plates">Tapas/Small Plates</option>
                            <option value="Tex-Mex">Tex-Mex</option>
                            <option value="Thai">Thai</option>
                            <option value="Tobacco Shops">Tobacco Shops</option>
                            <option value="Turkish">Turkish</option>
                            <option value="Vegan">Vegan</option>
                            <option value="Vegetarian">Vegetarian</option>
                            <option value="Venues & Event Spaces">Venues & Event Spaces</option>
                            <option value="Vietnamese">Vietnamese</option>
                            <option value="Waffles">Waffles</option>
                            <option value="Wine Bars">Wine Bars</option>
                            <option value="Wraps">Wraps</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="price">Price:</label>
                        <select class="form-control" name="price" id="price">
                            <option value="">Any</option>
                            <option value="$">$</option>
                            <option value="$$">$$</option>
                            <option value="$$$">$$$</option>
                            <option value="$$$$">$$$$</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="rating">Minimum Rating:</label>
                        <select class="form-control" name="rating" id="rating">
                            <option value="">Any</option>
                            <option value="0.5">0.5</option>
                            <option value="1.0">1.0</option>
                            <option value="1.5">1.5</option>
                            <option value="2.0">2.0</option>
                            <option value="2.5">2.5</option>
                            <option value="3.0">3.0</option>
                            <option value="3.5">3.5</option>
                            <option value="4.0">4.0</option>
                            <option value="4.5">4.5</option>
                            <option value="5.0">5.0</option>
                        </select>
                    </div>
                </div>                
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="review_count">Minimum Review Count:</label>
                        <select class="form-control" name="review_count" id="review_count">
                            <option value="">Any</option>
                            <option value="10">10</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="70">70</option>
                            <option value="100">100</option>
                            <option value="300">300</option>
                            <option value="500">500</option>
                            <option value="500">More</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="transactions">Transactions (comma separated):</label>
                        <select class="form-control" name="transactions" id="transactions">
                            <option value="">Any</option>
                            <option value="pickup">pickup</option>
                            <option value="delivery">delivery</option>
                            <option value="restaurant_reservation">restaurant_reservation</option>
                        </select>                  
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="sort_by">Sort By:</label>
                        <select class="form-control" name="sort_by" id="sort_by">
                            <option value="">None</option>
                            <option value="name">Name</option>
                            <option value="rating">Rating</option>
                            <option value="review_count">Review Count</option>
                            <option value="price">Price</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </div>
        </form>

        <button type="button" class="btn btn-secondary" onclick="resetPage()" id="reset">Reset</button>

        <!-- 餐厅列表 -->
            {% if restaurants %}
            <div class="mt-4">
                <h2>Restaurants</h2>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Categories</th>
                            <th>Rating</th>
                            <th>Price</th>
                            <th>Review Count</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for restaurant in restaurants %}
                        <tr>
                            <td><a href="{{ restaurant.url }}" target="_blank">{{ restaurant.name }}</a></td>
                            <td>{{ restaurant.categories }}</td>
                            <td>{{ restaurant.rating }}</td>
                            <td>{{ restaurant.price }}</td>
                            <td>{{ restaurant.review_count }}</td>
                            <td>{{ restaurant.transactions }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>                
            </div>
        {% else %}
        <p>No restaurants found!!!!!</p>
        {% endif %}

        <!-- 在这里添加分页控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination" id="pagination">
                {% for i in range(1, total_pages + 1) %}
                <li class="page-item {% if i == current_page %}active{% endif %}">
                    <a class="page-link" href="#" onclick="loadPage({{ i }})">{{ i }}</a>
                </li>
                {% endfor %}
            </ul>
        </nav>

        <!-- 地图 -->
        <div class="mt-5">
            <h2>Map</h2>
            <iframe src="{{ url_for('static', filename='map.html') }}" width="100%" height="500"></iframe>
        </div>
    </div>

    <script>
        // 定义状态对象
        var currentState = {
            query: '',
            categories: '',
            price: '',
            rating: '',
            review_count: '',
            transactions: '',
            sort_by: '',
            page: 1,
            totalPages: 0 // 添加这个属性来存储总页数
        };
    
        // 更新状态并搜索
        function updateStateAndSearch() {
            // 从表单元素中更新状态
            currentState.query = document.querySelector('[name="search_query"]').value;
            currentState.categories = Array.from(document.querySelector('#categories').selectedOptions)
            .map(option => option.value)
            .join(';');
            currentState.price = document.querySelector('[name="price"]').value;
            currentState.rating = document.querySelector('[name="rating"]').value;
            currentState.review_count = document.querySelector('[name="review_count"]').value;
            currentState.transactions = Array.from(document.querySelector('#transactions').selectedOptions)
            .map(option => option.value)
            .join(';');
            currentState.sort_by = document.querySelector('[name="sort_by"]').value;
    
            // 执行搜索
            loadPage(1);
        }
    
        // 加载指定页面
        function loadPage(page) {
            currentState.page = page;
            const queryParams = new URLSearchParams(currentState).toString();
            fetch(`/api/restaurants?${queryParams}`)
                .then(response => response.json())
                .then(data => {
                    updateRestaurantsTable(data.restaurants);
                    updatePagination(data.current_page, data.total_pages);
                    updateMap(data.map_url);  // 使用新的地图 URL 更新地图
                    currentState.totalPages = data.total_pages; // 更新总页数
                    bindRestaurantDetails();
                })
                .catch(error => console.error('Error:', error));
        }
    
        // 更新餐厅表格
        function updateRestaurantsTable(restaurants) {
            const tableBody = document.querySelector('.table tbody');
            tableBody.innerHTML = '';
            restaurants.forEach(restaurant => {
                tableBody.innerHTML += `
                    <tr>
                        <td><a href="${restaurant.url}" target="_blank">${restaurant.name}</a></td>
                        <td>${restaurant.categories}</td>
                        <td>${restaurant.rating}</td>
                        <td>${restaurant.price}</td>
                        <td>${restaurant.review_count}</td>
                        <td>${restaurant.transactions}</td>
                    </tr>
                `;
            });
        }

        // 更新地图的函数
        function updateMap(mapUrl) {
            const mapIframe = document.querySelector('iframe');
            mapIframe.src = mapUrl;
        }
    
        // 更新分页控件
        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const maxPagesToShow = 5; // 显示的最大页码数量
        
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
            // 确保始终显示5个页码（在可能的情况下）
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
        
            // 添加“上一页”按钮
            pagination.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage - 1})">Previous</a>
                </li>
            `;
        
            // 添加页码和省略号
            if (startPage > 1) {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadPage(1)">1</a></li>`;
                if (startPage > 2) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
        
            for (let i = startPage; i <= endPage; i++) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPage(${i})">${i}</a>
                    </li>
                `;
            }
        
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadPage(${totalPages})">${totalPages}</a></li>`;
            }
        
            // 添加“下一页”按钮
            pagination.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadPage(${currentPage + 1})">Next</a>
                </li>
            `;
        
            // 添加页码跳转输入框
            pagination.innerHTML += `
                <li class="page-item">
                    <input type="number" id="page-number-input" min="1" max="${totalPages}" placeholder="${currentPage}">
                    <button onclick="jumpToPage()">Go</button>
                </li>
            `;
        }
        
        // 跳转到指定页码的函数
        function jumpToPage() {
            const pageNumber = parseInt(document.getElementById('page-number-input').value);
            if (pageNumber && pageNumber >= 1 && pageNumber <= currentState.totalPages) {
                loadPage(pageNumber);
            }
        }     
        
    
        // 绑定餐厅详细信息的点击事件
        function bindRestaurantDetails() {
            const restaurantLinks = document.querySelectorAll('.restaurant-link');
            restaurantLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const index = link.getAttribute('data-index');
                    fetch(`/details/${index}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                            // 在此处显示餐厅详细信息
                        });
                });
            });
        }
    
        // 重置页面
        function resetPage() {
            currentState = {
                query: '',
                categories: '',
                price: '',
                rating: '',
                review_count: '',
                transactions: '',
                sort_by: '',
                page: 1
            };
            document.querySelector('[name="search_query"]').value = '';
            document.querySelector('[name="categories"]').value = '';
            document.querySelector('[name="price"]').value = '';
            document.querySelector('[name="rating"]').value = '';
            document.querySelector('[name="review_count"]').value = '';
            document.querySelector('[name="transactions"]').value = '';
            document.querySelector('[name="sort_by"]').value = '';
            loadPage(1);
        }
    
        // 绑定表单事件
        document.getElementById('search-form').addEventListener('submit', function(event) {
            event.preventDefault();
            updateStateAndSearch();
        });
    
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault();
            updateStateAndSearch();
        });
    
        // 初始化页面
        loadPage(1);
    </script>
    
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2023 Yanzhuo Cao. All Rights Reserved.</p>
            <p>Follow me on:
                <a href="https://github.com/yanzhuo2001" target="_blank">Github</a> |
                <a href="www.linkedin.com/in/yanzhuo1029" target="_blank">LinkedIn</a> |
            </p>
        </div>
    </footer>

</body>
</html>
